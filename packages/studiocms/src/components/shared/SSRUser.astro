---
import { Icon } from 'studiocms:ui/components/icon';

const heroIconsUserDataUri =
	'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADSklEQVR4AdSWS2xMYRTHjQXRRupRKVWrJhrxSCRigTQpYUHq0VYsarwi8RgJ0rCwFJEQEQ1psZFQXWgGRZB6NdFalkSFFRutV1UJNhLj9+dcOubeud8dC2lzfvd/7vedc77TO999DB/2n/+GZgOpVCoOSegx5K/N5WJGugIsNhHusNBZqIJiQ/455tqgiDFni9QAVZthIVyBBTAWJsBKeAOL4Tw4m3MD/GebqVoBV2Ox2ArohAHog1bGZ0MfLCJ2A+pkzg1QrRpkB3X4G5p4xdhOkOknkYYSpYE5Vu2pqZ/ctUFdDXOzS5QGvlkplxyXmJ/lnAOJfgSyMh0C0AbVVJcOLkRp4JQV3GeaJmy8SQzUg6xRBxecG2CTaaffpGgli12DeVAAhaDb8CFzhXCZ2Ouokzk3YNU2ordhGXTCALyDS6AH0C10CzhbpAb4z16DHjZxVtCivWgPJCHO3BJ4i+9skRrwqrJIE1TBZCiBGmjy5qNoTg1EWSAsNlIDbLZi2AEt0A2fDPkX8BOguyFs3d/zTg1QNB+OkPUcjkMNTIfRhvzV+CfgBbGHYBR+qIU2QCG97dqpVAcjoRuOgpqYggr5GnvCuWL2ou3kjkOzWtYGKFBAdgfoPfAR1S02iw1XB0l4achXgzOJ2QaKnYt2WA1cfwtsgETNtZA2FXR/l7LYaUhx7muag5NMloI+XKahzdSKob6mRXwnGEyA7nm949dQ+D3nTmax2hN6SC0lSVcOyTTfBuhYl36/hddS8IP5zmI56y3hADW1Ye30j/g2wLQ21Ri0i0JtaE5G7g0SH8N40PsCSbegBiot7J7pv4hXw6uZViuogRkWpdvP3JzFq6E7JKNIUAP63FbwJn67KsjTSRSUA/o2XGd5Xk07/SVBDei7/zshq0Bvun6KtcIeqIUKKAM9IfNQ+RrTnGL07dBvufrtVesM5xnm2wCbZyuRer9vR+/DCFgOh0FvPX18PsP/DF9AvsY0pxjFKke5up2LqLmLuAzzbUBRJOh7vxEt57wEVKABvQgPQO+Fr6iQrzHNKWY343pNl5PfAHqWMJRpgQ0MDqVAL9RDAqphPujJmI8K+RrTnGKOMa6PlcFlfH2nBnwzHQfDwn4AAAD//6qWhy8AAAAGSURBVAMAJXQ0UKI3Vu0AAAAASUVORK5CYII=';

interface Props {
	/**
	 * The name of the user.
	 */
	name: string;
	/**
	 * The description of the user. Could be a role, a handle, etc.
	 */
	description: string;
	/**
	 * The avatar of the user. Either a URL to an image or an imported image.
	 */
	avatar?: string;
	/**
	 * Additional classes to apply to the user container.
	 */
	class?: string;
	/**
	 * The loading strategy for the image. Defaults to `lazy`.
	 */
	loading?: 'eager' | 'lazy';

	/**
	 * The timeout delay for loading the avatar image. Defaults to 5000ms.
	 */
	timeoutDelay?: number;

	id: string;
}

const {
	name,
	description,
	avatar,
	class: className,
	loading = 'lazy',
	timeoutDelay = 3000,
	id,
} = Astro.props;

// Generate unique ID for this avatar instance
const avatarId = `avatar-${id}-${Math.random().toString(36).substring(7)}`;
---

<div class="sui-user-container" class:list={[className]} id={id}>
    <div class="sui-avatar-container" id={avatarId}>
    <Icon
        name="heroicons:user"
        width={24}
        height={24}
        role="img"
        aria-label={`Placeholder avatar for ${name}`}
        class="sui-avatar-fallback"
    />
</div>
    <div class="sui-text-content">
        <span class="sui-name">{name}</span>
        <span class="sui-description">{description}</span>
    </div>
</div>

<script define:vars={{ avatar, avatarId, name, loading, timeoutDelay, heroIconsUserDataUri }}>
    if (avatar) {
        const container = document.getElementById(avatarId);
        if (!container) return;

        const isValidUrl = (url) => {
            try {
                const urlObj = new URL(url);
                return urlObj.protocol === 'https:' || urlObj.protocol === 'http:' || urlObj.protocol === 'data:';
            } catch {
                return false;
            }
        };

        const isSvg = (url) => {
            return url.toLowerCase().endsWith('.svg') || 
                   url.toLowerCase().includes('.svg?') ||
                   url.toLowerCase().includes('image/svg');
        };

        if (!isValidUrl(avatar) || isSvg(avatar)) {
            return;
        }

        // Create image element
        const img = document.createElement('img');
        img.src = avatar;
        img.width = 64;
        img.height = 64;
        img.className = 'sui-avatar-img';
        img.alt = name;
        img.loading = loading;
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
        
        // Set up timeout
        const timeoutId = setTimeout(() => {
            img.src = '';
        }, timeoutDelay);

        // Handle load
        img.onload = () => {
            clearTimeout(timeoutId);
            const fallback = container.querySelector('.sui-avatar-fallback');
            if (fallback) {
                container.removeChild(fallback);
            }
            container.appendChild(img);
        };

        img.onerror = () => {
            clearTimeout(timeoutId);
            if (img.src !== heroIconsUserDataUri) {
                img.src = heroIconsUserDataUri;
            } else {
                img.remove();
            }
        };
    }
</script>

<style>
    .sui-user-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1rem;
    }
    .sui-avatar-container {
        width: 2.5rem;
        height: 2.5rem;
        background-color: var(--default-base);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border: 1px solid var(--border);
    }
    .sui-avatar-img {
        width: 100%;
        height: auto;
        display: flex;
        align-items: center;
        justify-content: center;
		opacity: 0;
		animation: fadeIn 0.2s ease-in forwards;
    }
	.sui-avatar-fallback {
    	opacity: 1;
	}
    .sui-text-content {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }
    .sui-name {
        font-size: 1em;
        font-weight: 600;
    }
    .sui-description {
        font-size: 0.875em;
        font-weight: 400;
        color: var(--text-muted);
    }
	@keyframes fadeIn {
		to {
			opacity: 1;
		}
	}
</style>
